version: '3.8'

services:
  # Development agent with medium restrictions
  agent-dev:
    build: .
    image: vectra-guard:latest
    container_name: vectra-agent-dev
    environment:
      - AGENT_NAME=cursor-ai-dev
      - WORKSPACE=/workspace
    volumes:
      # Mount workspace (read-write)
      - ./:/workspace
      # Separate writable scratch space
      - agent-scratch:/workspace-rw
    networks:
      - agent-net
    # No special capabilities
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    stdin_open: true
    tty: true

  # Production agent with strict restrictions
  agent-prod:
    build: .
    image: vectra-guard:latest
    container_name: vectra-agent-prod
    environment:
      - AGENT_NAME=cursor-ai-prod
      - WORKSPACE=/workspace
    volumes:
      # Mount workspace READ-ONLY
      - ./:/workspace:ro
      # Writable output directory only
      - agent-output:/workspace/dist
    networks:
      - none  # No network access
    # Minimal capabilities
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
      - seccomp=seccomp-profile.json
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
    stdin_open: true
    tty: true
    read_only: true
    tmpfs:
      - /tmp:size=100M,mode=1777

  # High-security agent (for untrusted code)
  agent-sandbox:
    build: .
    image: vectra-guard:latest
    container_name: vectra-agent-sandbox
    environment:
      - AGENT_NAME=untrusted-agent
      - WORKSPACE=/workspace
    volumes:
      # Minimal mounts, all read-only
      - ./:/workspace:ro
    # No network
    network_mode: none
    # Drop all capabilities
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
      - apparmor=vectra-guard-strict
    # Strict resource limits
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
    # Completely read-only filesystem
    read_only: true
    tmpfs:
      - /tmp:size=50M,mode=1777,noexec,nosuid
    # No stdin/stdout (log only)
    stdin_open: false
    tty: false
    # Auto-remove after exit
    rm: true

networks:
  agent-net:
    driver: bridge
    internal: false  # Allow internet
  
  none:
    driver: none

volumes:
  agent-scratch:
    driver: local
  agent-output:
    driver: local

